<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="fh-stundenplan-app">
    <template>
        <style>
            :host {
                display: block;
                min-width: 300px;
            }
            app-header {
                background-color: #F44336;
                color: #fff;
            }
            #tabs{
                width: 100%;
                max-width: 750px;
                margin: 0 auto;
            }
            .tab{
                min-width: 64px;
            }
            paper-dialog{
                position: absolute;
                min-height: 280px;
                max-width: 420px;
                min-width: 200px;
                left: 1.5%;
                top: 21%;
                right: 1.5%;
                margin-right: auto;
                margin-left: auto;
                padding-bottom: 30px;

            }
            paper-toggle-button{
                display: inline-flex;
            }
            #Studiengang{
                width: 84%;
            }
            #group{
                width: 80px;
                color: #FFF;
            }
            #groupLetterMenu{
                    width: 75px;
            }
        </style>
        <iron-ajax id="ajax"
             auto
             url="[[baseFeedUrl]]",
             params='{"Accept": "application/json"}'
             handle-as="json"
             last-response="{{responseRaw}}">   
        </iron-ajax> 
        <paper-dialog id="settingsDialog">
            <h2>Einstellungen</h2>
            <paper-dropdown-menu id="Studiengang" label="Studiengang">
                <paper-listbox id="courseMenu" slot="dropdown-content" selected="{{course}}" 
                                attr-for-selected="value">
                    <template is="dom-repeat" items="{{response}}" as="courses">
                        <template is="dom-repeat" items="{{courses.grades}}" as="itemGrade" >
                            <paper-item data="{{itemGrade.grade}}" value="{{courses.key}} {{itemGrade.grade}}">{{courses.name}} {{itemGrade.grade}}</paper-item>
                        </template>
                    </template>
                </paper-listbox>
            </paper-dropdown-menu>
            <paper-dropdown-menu label="Gruppenbuchstabe" > 
                <paper-listbox slot="dropdown-content" id="groupLetterMenu"  
                               selected="{{currentGroupLetter}}" attr-for-selected="value">
                    <template is="dom-repeat" items="{{_allGroupLetters}}" as="item" initial-count="8">
                       <paper-item value="{{item}}">{{item}}</paper-item>
                    </template>
                </paper-listbox>
            </paper-dropdown-menu>
            <paper-toggle-button id="filterByGroup" checked="{{filterByGroup}}">Nach Gruppenbuchstabe filtern</paper-toggle-button>
            <paper-toggle-button id="qdlButton" checked="{{qdl}}">QDL's anzeigen</paper-toggle-button><br>
        </paper-dialog>
        <app-header-layout has-scrolling-region="true" fullbleed>        
            <app-header slot="header" effects="waterfall" fixed>
                <app-toolbar>
                    <div main-title>FH-Stundenplan</div>
                    <paper-icon-button on-click="showSettings" icon="settings"></paper-icon-button>
                </app-toolbar>
                <app-toolbar id="tabsToolbar" style="height: 52px;">
                        <paper-tabs id="tabs" selected="{{day}}" autoselect-delay="0" no-slide autoselect hide-scroll-buttons="true" scrollable="true" fit-container="true" attr-for-selected="value" >
                            <paper-tab class="tab" value="Mon">Montag</paper-tab>
                            <paper-tab class="tab" value="Tue">Dienstag</paper-tab>
                            <paper-tab class="tab" value="Wed">Mittwoch</paper-tab>
                            <paper-tab class="tab" value="Thu">Donnertstag</paper-tab>
                            <paper-tab class="tab" value="Fri">Freitag</paper-item>
                        </paper-tabs>
                </app-toolbar>
            </app-header>
            <div>
                <stundenplan-feed course-id="{{course}}" qdl="{{qdl}}" current-group-letter="{{currentGroupLetter}}"  
                                      feed-events-url="[[feedEventsUrl]]" week-day="[[day]]" filter-by-group="{{filterByGroup}}">
                </stundenplan-feed>
            </div>
        </app-header-layout>    

    </template>
    <script>
    /**
     * @customElement
     * @polymer
     */
    class FhStundenplanApp extends Polymer.Element {
        static get is() { return "fh-stundenplan-app"; }
        static get properties() {
            return {
                day:{
                    type: String,
                    observer: "reload"
                },
                name: {
                    type: String,
                    value: "fh-stundenplan-app"
                },
                responseRaw: {
                        type: Object,
                        observer: "handleResponse"
                },
                response: {
                    type: Array,
                        
                },
                baseFeedUrl:{
                    type: String,
                    value: "https://ws.inf.fh-dortmund.de/timetable/current/rest/CourseOfStudy/"
                },
                _allGroupLetters:{
                    type: Array,
                    value: ["A", "B", "C","D","E","F","G","H","I","J","K",
                                "L","M","N","O","P","Q","L", "R","S","T","U",
                                "V","W","Y","Z"]
                },
                filterByGroup:{
                    type: Boolean,
                    value: false,
                    observer: "filterByGroupChanged"
                },
                qdl:{
                    type: Boolean,
                    value: false,
                    observer: "qdlChanged"
                },
                course:{
                    type: String,
                    observer: "settingsChanged"
                },
                currentGroupLetter:{
                    type: String,
                    observer: "settingsChanged"
                }
            };
        }
        ready(){
            super.ready();
            Polymer.RenderStatus.afterNextRender(this, function() {
                if (localStorage.feedEventsUrl == null ) {
                    this.$.settingsDialog.open();
                }
            });
            if(localStorage.feedEventsUrl != null){
                    this.feedEventsUrl = localStorage.feedEventsUrl;
            }
            if (localStorage.currentGroupLetter != null) {
                this.currentGroupLetter = localStorage.currentGroupLetter;
            }
            if (localStorage.qdl == null) {
                this.qdl = localStorage.qdl;
            }
            if (localStorage.filterByGroup != null) {
                this.filterByGroup = localStorage.filterByGroup;
            }
        }
        handleResponse(){
            var arrKeys = [],
                arrResponseTemp = [],
                myObjekt = {},
                i = 0;
            var toDay = new Date();
            var tmpDay = toDay.getDay();
            if (tmpDay == 0 || tmpDay == 6) {
                this.day = "Mon";
            }else{
                this.day = toDay.toDateString().split(" ")[0];;
            }
            if (this.responseRaw != null){
                arrKeys = Object.keys(this.responseRaw);
                for(var item in this.responseRaw){
                    myObjekt = {key: "a", name: "b", grades: [{"grade":"","modified":0}]};
                    myObjekt.name = this.responseRaw[item].name;
                    myObjekt.grades = this.responseRaw[item].grades.slice();
                    myObjekt.key = arrKeys[i++];
                    arrResponseTemp.push(myObjekt); 
                }
                this.response = arrResponseTemp;
            } 
        }
        showSettings(){
            this.$.settingsDialog.open();
            this.settingsDialogOpened();
        }
        qdlChanged(newValue, oldValue){
            localStorage.qdl = newValue;
            this.reload();
        }
        settingsChanged(){
            if (this.course != null && this.currentGroupLetter != null ) {
                localStorage.currentGroupLetter = this.currentGroupLetter;
                localStorage.currentCourse = this.course;
                var feedEventsUrl = this.baseFeedUrl + this.course.split(" ")[0] + "/" + this.course.split(" ")[1] + "/Events";
                localStorage.feedEventsUrl = feedEventsUrl; 
                this.feedEventsUrl = feedEventsUrl;        
                this.reload();
            }
        }
        showImpressumDialog(){
            this.$.settingsDialog.close();
            this.$.impressumDialog.open();
        }
        settingsDialogOpened(){
            this.handleResponse();
            if(localStorage.currentCourse != null){
                this.course = localStorage.currentCourse;   
            }
        }
        reload(){
            this.dispatchEvent(new CustomEvent('reload'));
        }
        filterByGroupChanged(newValue, oldValue){
            localStorage.filterByGroup = newValue;
            this.reload();
        }
    }

    window.customElements.define(FhStundenplanApp.is, FhStundenplanApp);
    </script>
</dom-module>
