<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../elements.html">

<dom-module id="fh-stundenplan-app">
    <template>
        <style>
             :host {
                display: block;
                min-width: 300px;
            }

            app-header {
                background-color: #F44336;
                color: #fff;
                padding-bottom: 2px;
                padding-left: 10px;
                padding-right: 10px;
            }

            paper-tabs {
                max-width: 750px;
                margin: 0 auto;
            }
            paper-tabs, iron-pages stundenplan-feed{
                width: 100%;
            }
            iron-pages stundenplan-feed{
                margin-bottom: 5%;
            }
            iron-pages paper-material {
                display: block;
                padding: 16px;
                background-color: #fff;
                width: 85%;
              
            }
            iron-pages stundenplan-feed, iron-pages paper-material{
                margin: 3% auto;
                max-width: 720px;
            }

            paper-tabs {
                min-width: 54px;
            }

            app-toolbar {
                height: 64px;
            }

            @media(max-width: 650px) {
                app-toolbar {
                    height: 52px;
                }
                iron-pages paper-material{
                    width: 90%;
                }
            }
        </style>
        <app-header-layout has-scrolling-region fullbleed>
            <app-header slot="header" effects="waterfall" fixed>
                <app-toolbar>
                    <div main-title>FH-Stundenplan</div>
                    <paper-icon-button on-click="showSettings" icon="settings"></paper-icon-button>
                </app-toolbar>
                <paper-tabs id="tabs" auto-select-delay="0" selected="{{page}}" 
                            no-slide autoselect hide-scroll-buttons="true" 
                            scrollable fit-container="true"
                            attr-for-selected="page">
                    <paper-tab page="0" day="Mon">Montag</paper-tab>
                    <paper-tab page="1" day="Tue">Dienstag</paper-tab>
                    <paper-tab page="2" day="Wed">Mittwoch</paper-tab>
                    <paper-tab page="3" day="Thu">Donnerstag</paper-tab>
                    <paper-tab page="4" day="Fri">Freitag</paper-tab>
                </paper-tabs>
            </app-header>
                <stundenplan-fetcher 
                    response="{{data}}" 
                    feed-events-url="[[feedEventsUrl]]">
                </stundenplan-fetcher>
                <iron-pages id="pages" selected="{{page}}" attr-for-selected="page">
                    <stundenplan-feed 
                        list-original="[[data.mon]]"
                        filter-by="{{filterBy}}"
                        week-day="mon"
                        page="0">
                    </stundenplan-feed>
                    <stundenplan-feed 
                        list-original="[[data.tue]]"
                        filter-by="{{filterBy}}" 
                        week-day="tue"
                        page="1">
                    </stundenplan-feed>
                    <stundenplan-feed 
                        list-original="[[data.wed]]"
                        filter-by="{{filterBy}}" 
                        week-day="wed"
                        page="2">
                    </stundenplan-feed>
                    <stundenplan-feed
                        list-original="[[data.thu]]"
                        filter-by="{{filterBy}}" 
                        week-day="thu"
                        page="3">
                    </stundenplan-feed>
                    <stundenplan-feed 
                        list-original="[[data.fri]]"
                        filter-by="{{filterBy}}" 
                        week-day="fri"
                        page="4">
                    </stundenplan-feed>
                    <paper-material page="5">
                        <stundenplan-settings id="settings" 
                            on-close="closeSettings"
                            on-feed="handleFeedEvent"
                            on-reset="closeSettings"
                            url="[[baseFeedUrl]]" 
                            on-filter="handleFilterEvent">
                        </stundenplan-settings>
                    </paper-material>
                </iron-pages>
        </app-header-layout>
    </template>
        <script>
            class FhStundenplanApp extends Polymer.Element {
            static get is() { return "fh-stundenplan-app"; }
            static get properties() {
                return {
                    name: {
                        type: String,
                        value: "fh-stundenplan-app"
                    },
                    baseFeedUrl: {
                        type: String,
                        value: "https://api.fhstundenplan.de"
                    },
                    lastSelectedDay: Number

                };
            }
            connectedCallback() {
                super.connectedCallback();
                const toDay = new Date();
                this.lastSelectedDay = toDay.getDay() - 1;  
                Polymer.RenderStatus.afterNextRender(this, () => {
                    if (toDay.getDay() == 0 || toDay.getDay() == 6) {
                        this.$.tabs.selected = 0;
                        this.lastSelectedDay = this.$.tabs.selected;
                    } else {
                        this.$.tabs.selected = this.lastSelectedDay;
                    }       
                    if (localStorage.feedEventsUrl == null) {
                        this.showSettings();
                    } 
                });

                if (localStorage.feedEventsUrl != null) {
                    this.feedEventsUrl = localStorage.feedEventsUrl;
                }
            }
            showSettings(){
                if (this.$.tabs.selected === 5){
                    this.closeSettings();
                } else {
                    if (this.$.tabs.selected != undefined){
                        this.lastSelectedDay = this.$.tabs.selected;
                    }
                    this.$.pages.select(5);
                    this.$.tabs.style.visibility = "hidden";
                }
            }
            closeImpressum(){
                this.$.pages.select(0);
            }
            handleFeedEvent(event) {
                console.log(event);
                // let feedEventsUrl = this.baseFeedUrl + event.detail.course.split(" ")[0] + "/" +
                //     event.detail.course.split(" ")[1] + "/Events";
                console.log(event.detail.course);
                const eventDetail = event.detail.course.split(" ");
                const courseOfStudy =  eventDetail[0];
                const semestester = eventDetail[1]
                let feedEventsUrl = `${this.baseFeedUrl}/events/${courseOfStudy}/${semestester}`;
                console.log(feedEventsUrl);
                localStorage.feedEventsUrl = feedEventsUrl;
                this.feedEventsUrl = feedEventsUrl;
                console.log(this.feedEventsUrl);
            }
            handleFilterEvent(event) {
                this.filterBy = event.detail;
            }
            closeSettings() {
                this.$.settings.impressumVisible = false;
                this.$.tabs.style.visibility = "visible";
                this.$.pages.select(this.lastSelectedDay);
            }
            handleResetEvent() {
                if (localStorage.savedEvents != null) {
                    let cachedEvents = JSON.parse(localStorage.savedEvents);
                    cachedEvents[this.$.pages.selected] = [];
                    localStorage.savedEvents = JSON.stringify(cachedEvents);
                    this.closeSettings();
                    //call reset method for the selected day
                    this.$.pages.selectedItem.reset();
                }
            }

        }
        window.customElements.define(FhStundenplanApp.is, FhStundenplanApp);
    </script>
</dom-module>