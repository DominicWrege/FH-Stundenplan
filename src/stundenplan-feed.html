<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="stundenplan-feed">

	<template>
		<style>
		    :host {
                display: block;
                font-size: small;
                margin: 0 auto;
                margin-top: 3%;
                margin-bottom: 5%;
                max-width: 650px;
            }
            paper-material{
                display: block;
                padding: 16px;
                background-color: #ffffff;
            }
            @media (max-width: 700px) {
                :host{
                    margin-top: 0%;
                }
            }
			
		</style>
		<iron-ajax id="ajax"
             auto
             url="[[feedEventsUrl]]"
             params='{"Accept": "application/json"}'
             handle-as="json"
             last-response="{{response}}" >    
        </iron-ajax>
		<!-- <iron-list id="liste" scroll-target="document" > -->
        <div id="liste">
			<template is="dom-repeat" items="[[filter(response)]]" as="item">
				<paper-material elevation="1" >
					<table> 
						<tr>
							<td><b>[[item.courseType]] [[item.name]]</b></td>
						</tr>
						<tr>
							<td>[[formatTimePretty(item.timeBegin)]] - [[formatTimePretty(item.timeEnd)]] | [[item.roomId]]</td>
						</tr>
						<tr>
							<td>[[item.studentSet]] | [[item.lecturerName]]</td>
						</tr>                        
					</table>    
                </paper-material>
			</template>
        </div>    
		<!-- </iron-list> -->
	</template>
	<script>
		class StundenplanFeed extends Polymer.Element{
			static get is(){ return "stundenplan-feed";}
			static get properties() {
	            return {
	                name: {
	                	type: String,
	                	value: "stundenplan-feed"
	                },
	                response:{
	                	type: Array,
	                },
	                weekDay:{
	                	type: String,
	                	value: "Mon",
                        observer:"reloadList"
	                },
	                currentGroupLetter:{
	                	type: String
	                },
	                feeEventsUrl:{
	                	type: String
	                },
	                qdl: {
                        type: Boolean,
                        value: false,
                        observer:"reloadList"
                    },
                    filterByGroup: {
                        type: Boolean,
                        value: false,
                        observer:"reloadList"
                    }
	            }
        	};

        	connectedCallback() {
                super.connectedCallback();
                document.querySelector("#app").addEventListener("reload", () => this.reloadList()); 
                //this.reloadList();

            }
        	formatTimePretty(time){
                let timeFormated;
                if(time.substring(0,1) == 1){
                     timeFormated = time.substring(0,2) + ":" + time.substring(2,4) ;
                }else{
                    timeFormated = "0" + time.substring(0,1) + ":" + time.substring(1,3); 
                }
                return timeFormated;
            }
            filter(items) {
                if (items != null) {
                    return items.filter(item => {  
                        if (!this.filterByGroup && !this.qdl)
                            return item.weekday == this.weekDay && item.name.indexOf("QdL") == -1;
                        else if (!this.qdl && this.filterByGroup) 
                            return item.weekday == this.weekDay  && this.checkGroup(this.currentGroupLetter, item.studentSet) && item.name.indexOf("QdL") == -1;
                        else if (this.qdl && !this.filterByGroup) 
                            return item.weekday == this.weekDay;
                        else
                            return item.weekday == this.weekDay && this.checkGroup(this.currentGroupLetter, item.studentSet) && item.name.indexOf("QdL") == -1;
                    });
                }
            } 
            checkGroup(userGroupLetter, rangeGroupLetter){
                let letters = rangeGroupLetter.split("-");
                let firstLetter = letters[0].substring(0,1);

                if (rangeGroupLetter.indexOf(userGroupLetter) != -1) {
                    return true;
                }else if(letters[1] == null){
                      return false;
                }
                let lastLetter = letters[1].substring(0,1);
                let firstLetterAscii = firstLetter.charCodeAt(0);
                let lastLetterAcii = lastLetter.charCodeAt(0);
                let userGroupLetterAscii = userGroupLetter.charCodeAt(0);
                if( userGroupLetterAscii >= firstLetterAscii && userGroupLetterAscii <= lastLetterAcii){
                    return true;
                }
                return false;                
        	}   
        	reloadList(){
                if (this.response != null) {
                    let tmp = [];
                    tmp = this.response;
                    this.response = [];
                    this.response = tmp;

                }
            }
		}
		window.customElements.define(StundenplanFeed.is, StundenplanFeed);
	</script>


</dom-module>