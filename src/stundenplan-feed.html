<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="stundenplan-feed">
    <template>
        <iron-ajax id="ajax"
             auto
             url="[[feedEventsUrl]]"
             params='{"Accept": "application/json"}'
             handle-as="json"
             last-response="{{response}}"
            >    
        </iron-ajax>
            <iron-list id="list" scroll-target="document" items="[[filter(response)]]" as="item" >
                <template>
                    <div class="card" class="disable-swipe">
                        <paper-material elevation="1">
                            <table> 
                                <tr>
                                    <td id="title"><b>[[item.courseType]] [[item.name]]</b></td>
                                </tr>
                                <tr>
                                    <td>[[formatTimePretty(item.timeBegin)]] - [[formatTimePretty(item.timeEnd)]] | [[item.roomId]]</td>
                                </tr>
                                <tr>
                                    <td> [[item.studentSet]] | [[item.lecturerName]] </td>
                                </tr>                        
                            </table>
                        </paper-material>
                    </div>   
     
                </template>
            </iron-list>
    </template>
<!--      <style include="shared-styles"></style> -->
    <style>
        :host {
            font-size: small;
        }

        paper-material{
            margin-top: 14px;
            margin-right: 14px;
            margin-left: 14px;
            padding: 14px;
        }
        #title{
            padding-right: 14px;
        }

        #list{
            max-width: 650px;
            margin: 0 auto;
            padding-bottom: 35px;
        }
    </style>

    <script>
    Polymer({

        is: 'stundenplan-feed',

        properties: {
            response:{
                type: Array
            },
            weekDay:{
                type: String,
                value:"Mon",
            },
            currentGroupLetter: {
                type: String,
            },

            feedEventsUrl:{
                type: String
            },  
            qdl: {
                type: Boolean,
                value: false,
            },
            filterByGroup: {
                type: Boolean
            }    
        },
        ready: function(){
            var thisTmp = this;
            document.querySelector("#app").addEventListener("reload", function (e) {
                thisTmp.reloadList();
            })
        },
        reloadList: function(){
            if (this.response != null) {
                    var tmp = this.response;
                    // console.log(this.response);
                    this.response = null;
                    this.response = tmp;
            }
        },
        formatTimePretty: function(time){
            this.fire('loaded2', {kicked: true});
            var timeFormated;
            if(time.substring(0,1) == 1){
                 timeFormated = time.substring(0,2) + ":" + time.substring(2,4) ;
            }else{
                timeFormated = "0" + time.substring(0,1) + ":" + time.substring(1,3); 
            }
            return timeFormated;
        },
        filter: function (items) {
            if (items != null) {
                var thisTmp = this;
                return items.filter(function(item) {      
                    if (!thisTmp.filterByGroup && !thisTmp.qdl) {
                          return item.weekday == thisTmp.weekDay && item.name.indexOf("QdL") == -1;;
                    }  else if (!thisTmp.qdl && thisTmp.filterByGroup) {
                        return item.weekday == thisTmp.weekDay  && checkGroup(thisTmp.currentGroupLetter, item.studentSet, thisTmp.allGroupLetters) && item.name.indexOf("QdL") == -1;
                    }  else if (thisTmp.qdl && !thisTmp.filterByGroup) {
                        return item.weekday == thisTmp.weekDay ;
                    }  else if (thisTmp.qdl && thisTmp.filterByGroup) {
                        return item.weekday == thisTmp.weekDay && checkGroup(thisTmp.currentGroupLetter, item.studentSet, thisTmp.allGroupLetters);
                    }  else{
                        item.weekday == thisTmp.weekDay && checkGroup(thisTmp.currentGroupLetter, item.studentSet, thisTmp.allGroupLetters) && item.name.indexOf("QdL") == -1;
                    }              
                     // Filter      
                });
            }
                function checkGroup(userGroupLetter, rangeGroupLetter, allGroupLetters){
                    var letters = rangeGroupLetter.split("-");
                    var firstLetter = letters[0].substring(0,1);

                    if (rangeGroupLetter.indexOf(userGroupLetter) != -1) {
                        return true;
                    }else if(letters[1] == null){
                          return false;
                    }
                    var lastLetter = letters[1].substring(0,1);
                    var firstLetterAscii = firstLetter.charCodeAt(0);
                    var lastLetterAcii = lastLetter.charCodeAt(0);
                    var userGroupLetterAscii = userGroupLetter.charCodeAt(0);
                    if( userGroupLetterAscii >= firstLetterAscii && userGroupLetterAscii <= lastLetterAcii){
                        return true;
                    }
                    return false;                
                }
        },
    });
    </script>
</dom-module>
